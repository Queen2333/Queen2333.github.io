<html>
<!-- Head tag -->
<head>
  <meta charset="UTF-8">

  
  <title>
    Websocket |
    Majesty&#39;s blog
  </title>
  


  <meta name="description" content="">
  <meta name="author" content="Alex">
  <meta property="og:title" content="Websocket" />
  <meta property="og:description" content="" />
  <meta property='og:site_name' content='Majesty&#39;s blog' />
  <meta property="og:image" content="http://example.com/img/default.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:description" content="" />
  <meta name="twitter:title" content="Websocket" />

  <meta name="twitter:image" content="http://example.com/img/default.jpg" />

  <script src="https://www.amcharts.com/lib/4/core.js"></script>
  <script src="https://www.amcharts.com/lib/4/charts.js"></script>
  <script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz"
    crossorigin="anonymous">
  
<link rel="stylesheet" href="/css/style.css">


<meta name="generator" content="Hexo 5.4.2"></head>

<body>
    <!-- Menu -->
    <nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark page-navbar gradient">
  <div class="container">
    <a class="navbar-brand logo" href="http://example.com">
      Majesty&#39;s blog</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav"
      aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mx-auto">
        <li class="nav-item item">
          
        <li class="nav-item item">
          <a class="nav-link" href="/">
            Home</a>
        </li>
        
        <li class="nav-item item">
          <a class="nav-link" href="/archives">
            ğŸ—‚ï¸Archives</a>
        </li>
        
        <li class="nav-item item">
          <a class="nav-link" target="_blank" rel="noopener" href="https://hexo.io/">
            Hexo</a>
        </li>
        
        </li>
      </ul>
    </div>
  </div>
</nav>

    <main class="page main-page">
        <div class="container blogPost">
    <div class="row">
        <div class="col-sm-9 px-md-5">
            <h2 class="blog-post-title">
                Websocket
            </h2>
            <p class="meta">
                <i class="far fa-clock"></i>
                2024-11-21 
            </p>
            <!-- Content -->
            <h4 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h4><h5 id="åè®®æ¦‚è¿°ï¼š"><a href="#åè®®æ¦‚è¿°ï¼š" class="headerlink" title="åè®®æ¦‚è¿°ï¼š"></a>åè®®æ¦‚è¿°ï¼š</h5><pre><code>WebSocket æ˜¯ä¸€ç§æ ‡å‡†åŒ–åè®®ï¼ŒRFC 6455 å®šä¹‰ã€‚
ä¸ HTTP ä¸€æ ·ï¼ŒåŸºäº TCP è¿æ¥ï¼Œä½†ä¸åŒäº HTTP çš„è¯·æ±‚-å“åº”æ¨¡å‹ã€‚
æ”¯æŒå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å®æ—¶åŒå‘é€šä¿¡ã€‚</code></pre>
<h5 id="å·¥ä½œæµç¨‹ï¼š"><a href="#å·¥ä½œæµç¨‹ï¼š" class="headerlink" title="å·¥ä½œæµç¨‹ï¼š"></a>å·¥ä½œæµç¨‹ï¼š</h5><pre><code>1.æ¡æ‰‹é˜¶æ®µï¼šWebSocket ä½¿ç”¨ HTTP/1.1 åè®®è¿›è¡Œæ¡æ‰‹ï¼Œè¿æ¥æˆåŠŸåå‡çº§ä¸º WebSocket åè®®ã€‚

2.å®¢æˆ·ç«¯å‘é€ HTTP è¯·æ±‚å¤´ä¸­çš„ Upgrade: websocket å’Œ Connection: Upgradeã€‚

3.æ•°æ®ä¼ è¾“é˜¶æ®µï¼šæ¡æ‰‹æˆåŠŸåï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½¿ç”¨ WebSocket åè®®è¿›è¡Œæ•°æ®å¸§ä¼ è¾“ã€‚</code></pre>
<hr>
<h4 id="WebSocket-æ•°æ®å¸§"><a href="#WebSocket-æ•°æ®å¸§" class="headerlink" title="WebSocket æ•°æ®å¸§"></a>WebSocket æ•°æ®å¸§</h4><h5 id="WebSocket-æ•°æ®ä¼ è¾“å•ä½æ˜¯å¸§ï¼š"><a href="#WebSocket-æ•°æ®ä¼ è¾“å•ä½æ˜¯å¸§ï¼š" class="headerlink" title="WebSocket æ•°æ®ä¼ è¾“å•ä½æ˜¯å¸§ï¼š"></a>WebSocket æ•°æ®ä¼ è¾“å•ä½æ˜¯å¸§ï¼š</h5><pre><code>æ§åˆ¶å¸§ï¼šå¦‚è¿æ¥å…³é—­ã€Ping/Pongã€‚
æ•°æ®å¸§ï¼šå¯ä¼ è¾“æ–‡æœ¬æˆ–äºŒè¿›åˆ¶æ•°æ®ã€‚</code></pre>
<h5 id="æ•°æ®å¸§çš„ç»“æ„ï¼š"><a href="#æ•°æ®å¸§çš„ç»“æ„ï¼š" class="headerlink" title="æ•°æ®å¸§çš„ç»“æ„ï¼š"></a>æ•°æ®å¸§çš„ç»“æ„ï¼š</h5><pre><code>FINï¼šæ ‡å¿—æ˜¯å¦æ˜¯æ¶ˆæ¯çš„æœ€åä¸€å¸§ã€‚
Opcodeï¼šå¸§ç±»å‹ï¼ˆå¦‚æ–‡æœ¬ã€äºŒè¿›åˆ¶ã€Pingã€Pong ç­‰ï¼‰ã€‚
Maskï¼šå®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„æ•°æ®å¿…é¡»ä½¿ç”¨æ©ç ã€‚
Payloadï¼šè´Ÿè½½æ•°æ®ï¼Œæ–‡æœ¬é€šå¸¸æ˜¯ UTF-8 æ ¼å¼ã€‚</code></pre>
<hr>
<h4 id="ä¸-HTTP-çš„å…³ç³»å’ŒåŒºåˆ«"><a href="#ä¸-HTTP-çš„å…³ç³»å’ŒåŒºåˆ«" class="headerlink" title="ä¸ HTTP çš„å…³ç³»å’ŒåŒºåˆ«"></a>ä¸ HTTP çš„å…³ç³»å’ŒåŒºåˆ«</h4><h5 id="ç›¸åŒç‚¹"><a href="#ç›¸åŒç‚¹" class="headerlink" title="ç›¸åŒç‚¹"></a>ç›¸åŒç‚¹</h5><pre><code>æ¡æ‰‹é˜¶æ®µé€šè¿‡ HTTP/1.1 è¿›è¡Œã€‚
éƒ½åŸºäº TCP åè®®ã€‚</code></pre>
<h5 id="åŒºåˆ«"><a href="#åŒºåˆ«" class="headerlink" title="åŒºåˆ«"></a>åŒºåˆ«</h5><pre><code>HTTP æ˜¯æ— çŠ¶æ€çš„è¯·æ±‚-å“åº”æ¨¡å¼ï¼ŒWebSocket æ˜¯é•¿è¿æ¥çš„å…¨åŒå·¥é€šä¿¡ã€‚
WebSocket è¿æ¥å»ºç«‹åæ²¡æœ‰ HTTP è¯·æ±‚å¤´çš„å¼€é”€ï¼Œé€šä¿¡æ•ˆç‡æ›´é«˜ã€‚</code></pre>
<hr>
<h4 id="ä¼˜åŠ¿"><a href="#ä¼˜åŠ¿" class="headerlink" title="ä¼˜åŠ¿"></a>ä¼˜åŠ¿</h4><pre><code>å®æ—¶æ€§ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯éšæ—¶æ¨é€æ•°æ®ï¼Œæ— éœ€è½®è¯¢ã€‚
èŠ‚çœå¸¦å®½ï¼šä¸ HTTP é•¿è½®è¯¢ç›¸æ¯”ï¼ŒWebSocket çš„å¤´éƒ¨æ•°æ®è¾ƒå°ï¼Œé€šä¿¡æ›´é«˜æ•ˆã€‚
ä½å»¶è¿Ÿï¼šå‡å°‘äº†é‡å¤å»ºç«‹è¿æ¥çš„æ—¶é—´å¼€é”€ã€‚</code></pre>
<hr>
<h4 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h4><pre><code>å®æ—¶èŠå¤©ï¼ˆå¦‚ IM åº”ç”¨ã€åœ¨çº¿å®¢æœï¼‰ã€‚
å®æ—¶é€šçŸ¥ï¼ˆå¦‚äº¤æ˜“æé†’ã€ç¤¾äº¤åª’ä½“æé†’ï¼‰ã€‚
å®æ—¶æ•°æ®æ›´æ–°ï¼ˆå¦‚è‚¡ç¥¨è¡Œæƒ…ã€ä½“è‚²æ¯”åˆ†ï¼‰ã€‚
åœ¨çº¿æ¸¸æˆã€‚
å®æ—¶åä½œï¼ˆå¦‚å¤šäººåä½œç¼–è¾‘æ–‡æ¡£ï¼‰ã€‚</code></pre>
<hr>
<h4 id="å¸¸ç”¨æ“ä½œ"><a href="#å¸¸ç”¨æ“ä½œ" class="headerlink" title="å¸¸ç”¨æ“ä½œ"></a>å¸¸ç”¨æ“ä½œ</h4><h5 id="æ¡æ‰‹è¯·æ±‚ï¼ˆå®¢æˆ·ç«¯ï¼‰"><a href="#æ¡æ‰‹è¯·æ±‚ï¼ˆå®¢æˆ·ç«¯ï¼‰" class="headerlink" title="æ¡æ‰‹è¯·æ±‚ï¼ˆå®¢æˆ·ç«¯ï¼‰"></a>æ¡æ‰‹è¯·æ±‚ï¼ˆå®¢æˆ·ç«¯ï¼‰</h5><pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;chat HTTP&#x2F;1.1</span><br><span class="line">Host: example.com</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ&#x3D;&#x3D;</span><br><span class="line">Sec-WebSocket-Version: 13</span><br><span class="line"></span><br></pre></td></tr></table></figure></code></pre>
<h5 id="æ¡æ‰‹å“åº”ï¼ˆæœåŠ¡ç«¯ï¼‰"><a href="#æ¡æ‰‹å“åº”ï¼ˆæœåŠ¡ç«¯ï¼‰" class="headerlink" title="æ¡æ‰‹å“åº”ï¼ˆæœåŠ¡ç«¯ï¼‰"></a>æ¡æ‰‹å“åº”ï¼ˆæœåŠ¡ç«¯ï¼‰</h5><pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 101 Switching Protocols</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo&#x3D;</span><br></pre></td></tr></table></figure></code></pre>
<h5 id="å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼ˆå®¢æˆ·ç«¯-æœåŠ¡ç«¯ï¼‰"><a href="#å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼ˆå®¢æˆ·ç«¯-æœåŠ¡ç«¯ï¼‰" class="headerlink" title="å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼ˆå®¢æˆ·ç«¯/æœåŠ¡ç«¯ï¼‰"></a>å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼ˆå®¢æˆ·ç«¯/æœåŠ¡ç«¯ï¼‰</h5><pre><code>ä½¿ç”¨äºŒè¿›åˆ¶æˆ–æ–‡æœ¬å¸§ä¼ è¾“æ¶ˆæ¯ã€‚
æœåŠ¡ç«¯å¯ä»¥å“åº”å®¢æˆ·ç«¯çš„ Ping æ¶ˆæ¯ï¼ˆå‘é€ Pongï¼‰</code></pre>
<hr>
<h4 id="WebSocket-çš„å®ç°"><a href="#WebSocket-çš„å®ç°" class="headerlink" title="WebSocket çš„å®ç°"></a>WebSocket çš„å®ç°</h4><h5 id="æµè§ˆå™¨ç«¯"><a href="#æµè§ˆå™¨ç«¯" class="headerlink" title="æµè§ˆå™¨ç«¯"></a>æµè§ˆå™¨ç«¯</h5><pre><code><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;ws://example.com/socket&#x27;</span>);</span><br><span class="line">ws.onopen = <span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;Connected&#x27;</span>);</span><br><span class="line">ws.onmessage = <span class="function">(<span class="params">event</span>) =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;Message:&#x27;</span>, event.data);</span><br><span class="line">ws.onclose = <span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;Disconnected&#x27;</span>);</span><br><span class="line">ws.onerror = <span class="function">(<span class="params">error</span>) =&gt;</span> <span class="built_in">console</span>.error(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br></pre></td></tr></table></figure></code></pre>
<h5 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h5><pre><code>ä½¿ç”¨è¯­è¨€æ¡†æ¶ï¼š

Node.jsï¼šws åº“ã€‚
Pythonï¼šwebsockets æˆ– Socket.IOã€‚
Javaï¼šSpring WebSocket</code></pre>
<hr>
<h4 id="WebSocket-ä¸å®‰å…¨"><a href="#WebSocket-ä¸å®‰å…¨" class="headerlink" title="WebSocket ä¸å®‰å…¨"></a>WebSocket ä¸å®‰å…¨</h4><h5 id="WSSï¼ˆWebSocket-Secureï¼‰"><a href="#WSSï¼ˆWebSocket-Secureï¼‰" class="headerlink" title="WSSï¼ˆWebSocket Secureï¼‰"></a>WSSï¼ˆWebSocket Secureï¼‰</h5><pre><code>ä½¿ç”¨ TLS åŠ å¯†çš„ WebSocketï¼Œç±»ä¼¼ HTTPSã€‚
URL ä»¥ wss:// å¼€å¤´ã€‚</code></pre>
<h5 id="é˜²èŒƒé£é™©"><a href="#é˜²èŒƒé£é™©" class="headerlink" title="é˜²èŒƒé£é™©"></a>é˜²èŒƒé£é™©</h5><pre><code>è·¨ç«™è„šæœ¬æ”»å‡» (XSS)ï¼šéªŒè¯æ•°æ®æ¥æºã€‚
è·¨ç«™ WebSocket åŠ«æŒï¼šé€šè¿‡ Origin æˆ– Token éªŒè¯å®¢æˆ·ç«¯ã€‚</code></pre>
<hr>
<h4 id="WebSocket-ä¸å…¶ä»–æŠ€æœ¯çš„æ¯”è¾ƒ"><a href="#WebSocket-ä¸å…¶ä»–æŠ€æœ¯çš„æ¯”è¾ƒ" class="headerlink" title="WebSocket ä¸å…¶ä»–æŠ€æœ¯çš„æ¯”è¾ƒ"></a>WebSocket ä¸å…¶ä»–æŠ€æœ¯çš„æ¯”è¾ƒ</h4><p>HTTPé•¿è½®è¯¢                   åŠåŒå·¥     æ•°æ®æ›´æ–°é¢‘ç‡ä½      ç®€å•å®ç°<br>WebSocket                    å…¨åŒå·¥        å®æ—¶æ€§è¦æ±‚é«˜        é«˜æ•ˆã€ä½å»¶è¿Ÿ<br>Server-Sent Events (SSE)    å•å‘æ¨é€    æœåŠ¡ç«¯é¢‘ç¹æ¨é€æ•°æ®    ç®€å•å®ç°ï¼ŒåŸºäº HTTP</p>
<hr>
<h4 id="WebSocket-çš„æ‰©å±•"><a href="#WebSocket-çš„æ‰©å±•" class="headerlink" title="WebSocket çš„æ‰©å±•"></a>WebSocket çš„æ‰©å±•</h4><h5 id="å­åè®®ï¼ˆSubprotocolsï¼‰"><a href="#å­åè®®ï¼ˆSubprotocolsï¼‰" class="headerlink" title="å­åè®®ï¼ˆSubprotocolsï¼‰"></a>å­åè®®ï¼ˆSubprotocolsï¼‰</h5><pre><code>åº”ç”¨å±‚åè®®åœ¨ WebSocket ä¹‹ä¸Šå®šä¹‰ï¼Œä¾‹å¦‚ STOMPã€MQTTã€‚
æ¡æ‰‹æ—¶å¯é€šè¿‡ Sec-WebSocket-Protocol æŒ‡å®šã€‚</code></pre>
<h5 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h5><pre><code>WebSocket é•¿è¿æ¥éœ€è¦ Sticky Sessionï¼ˆä¼šè¯ç²˜æ»ï¼‰ã€‚
é€šè¿‡ Nginx ç­‰ä»£ç†æœåŠ¡å™¨æ”¯æŒã€‚</code></pre>
<h5 id="è¿æ¥ç®¡ç†"><a href="#è¿æ¥ç®¡ç†" class="headerlink" title="è¿æ¥ç®¡ç†"></a>è¿æ¥ç®¡ç†</h5><pre><code>å¿ƒè·³æ£€æµ‹ï¼ˆPing/Pongï¼‰ã€‚
æ–­çº¿é‡è¿ç­–ç•¥ã€‚</code></pre>
<h5 id="æ¶ˆæ¯åºåˆ—åŒ–"><a href="#æ¶ˆæ¯åºåˆ—åŒ–" class="headerlink" title="æ¶ˆæ¯åºåˆ—åŒ–"></a>æ¶ˆæ¯åºåˆ—åŒ–</h5><pre><code>JSONã€Protobufã€MessagePack ç­‰ã€‚</code></pre>
<h4 id="è°ƒè¯•ä¸ç›‘æ§"><a href="#è°ƒè¯•ä¸ç›‘æ§" class="headerlink" title="è°ƒè¯•ä¸ç›‘æ§"></a>è°ƒè¯•ä¸ç›‘æ§</h4><pre><code>ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ£€æŸ¥ WebSocket æ¶ˆæ¯ã€‚
ä½¿ç”¨å·¥å…·å¦‚ Wireshark æˆ– Fiddler ç›‘æ§æ•°æ®å¸§ã€‚</code></pre>
<hr>
<h4 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h4><h5 id="å®¢æˆ·ç«¯æ— æ³•ä¸æœåŠ¡ç«¯æˆåŠŸå»ºç«‹-WebSocket-è¿æ¥ï¼Œå¯èƒ½æŠ¥é”™-WebSocket-connection-failed-æˆ–-Error-during-WebSocket-handshake"><a href="#å®¢æˆ·ç«¯æ— æ³•ä¸æœåŠ¡ç«¯æˆåŠŸå»ºç«‹-WebSocket-è¿æ¥ï¼Œå¯èƒ½æŠ¥é”™-WebSocket-connection-failed-æˆ–-Error-during-WebSocket-handshake" class="headerlink" title="å®¢æˆ·ç«¯æ— æ³•ä¸æœåŠ¡ç«¯æˆåŠŸå»ºç«‹ WebSocket è¿æ¥ï¼Œå¯èƒ½æŠ¥é”™ WebSocket connection failed æˆ– Error during WebSocket handshake"></a>å®¢æˆ·ç«¯æ— æ³•ä¸æœåŠ¡ç«¯æˆåŠŸå»ºç«‹ WebSocket è¿æ¥ï¼Œå¯èƒ½æŠ¥é”™ WebSocket connection failed æˆ– Error during WebSocket handshake</h5><pre><code>1.åŸå› ï¼š

1&gt;æœåŠ¡ç«¯æœªæ­£ç¡®é…ç½® WebSocket åè®®æ”¯æŒã€‚
2&gt;é˜²ç«å¢™æˆ–ä»£ç†æœåŠ¡å™¨é˜»æ­¢äº† WebSocket åè®®ã€‚
3&gt;å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ URL æˆ–ç«¯å£é…ç½®é”™è¯¯ã€‚

2.è§£å†³æ–¹æ³•ï¼š

1&gt;æ£€æŸ¥æœåŠ¡ç«¯ä»£ç ï¼šç¡®ä¿æœåŠ¡ç«¯ç›‘å¬äº†æ­£ç¡®çš„ WebSocket è¯·æ±‚è·¯å¾„ã€‚
2&gt;ç¡®è®¤ URL å’Œç«¯å£ï¼šæ£€æŸ¥å®¢æˆ·ç«¯ä½¿ç”¨çš„ ws:// æˆ– wss:// æ˜¯å¦æ­£ç¡®ã€‚
3&gt;ä»£ç†æˆ–é˜²ç«å¢™é…ç½®ï¼š
    é…ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆå¦‚ Nginxï¼‰ä»¥æ”¯æŒ WebSocket åè®®:

    <figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /ws/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://localhost:8080;</span><br><span class="line">    <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
4&gt;è°ƒè¯•æ¡æ‰‹è¿‡ç¨‹ï¼šä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹ WebSocket æ¡æ‰‹è¯·æ±‚å’Œå“åº”ã€‚</code></pre>
<h5 id="WebSocket-è¿æ¥æ„å¤–æ–­å¼€ï¼Œå¯èƒ½æŠ¥é”™-WebSocket-is-closed-with-code-1006"><a href="#WebSocket-è¿æ¥æ„å¤–æ–­å¼€ï¼Œå¯èƒ½æŠ¥é”™-WebSocket-is-closed-with-code-1006" class="headerlink" title="WebSocket è¿æ¥æ„å¤–æ–­å¼€ï¼Œå¯èƒ½æŠ¥é”™ WebSocket is closed with code 1006"></a>WebSocket è¿æ¥æ„å¤–æ–­å¼€ï¼Œå¯èƒ½æŠ¥é”™ WebSocket is closed with code 1006</h5><pre><code>1.åŸå› ï¼š

1&gt;ç½‘ç»œä¸ç¨³å®šæˆ–è¶…æ—¶ã€‚
2&gt;æœåŠ¡å™¨å› èµ„æºé™åˆ¶ä¸»åŠ¨æ–­å¼€è¿æ¥ã€‚
3&gt;å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨ç¼ºå°‘å¿ƒè·³æ£€æµ‹æœºåˆ¶ã€‚

2.è§£å†³æ–¹æ³•ï¼š

1&gt;å®ç°å¿ƒè·³æ£€æµ‹ï¼š
    å®¢æˆ·ç«¯å®šæœŸå‘é€ Ping å¸§ï¼ŒæœåŠ¡ç«¯è¿”å› Pong å¸§ã€‚

    <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;ws://example.com/socket&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> heartbeatInterval;</span><br><span class="line"></span><br><span class="line">ws.onopen = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    heartbeatInterval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        ws.send(<span class="built_in">JSON</span>.stringify(&#123; <span class="attr">type</span>: <span class="string">&#x27;ping&#x27;</span> &#125;));</span><br><span class="line">    &#125;, <span class="number">30000</span>); <span class="comment">// æ¯ 30 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ws.onclose = <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(heartbeatInterval);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

2&gt;æ–­çº¿é‡è¿æœºåˆ¶
    å½“è¿æ¥æ–­å¼€æ—¶å°è¯•é‡æ–°è¿æ¥

    <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;ws://example.com/socket&#x27;</span>);</span><br><span class="line">    ws.onclose = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;Disconnected. Reconnecting...&#x27;</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(connect, <span class="number">5000</span>); <span class="comment">// 5 ç§’åé‡è¿</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line">connect();</span><br></pre></td></tr></table></figure>

3&gt;ä¼˜åŒ–æœåŠ¡ç«¯è¿æ¥ç®¡ç†
    ç¡®ä¿æœåŠ¡ç«¯æ²¡æœ‰å› è¶…å‡ºè¿æ¥æ•°é™åˆ¶è€Œæ–­å¼€è¿æ¥ã€‚
    ä½¿ç”¨è´Ÿè½½å‡è¡¡åˆ†æ•£è¿æ¥è´Ÿæ‹…ã€‚</code></pre>
<h5 id="å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯æœªæ”¶åˆ°é¢„æœŸçš„æ¶ˆæ¯"><a href="#å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯æœªæ”¶åˆ°é¢„æœŸçš„æ¶ˆæ¯" class="headerlink" title="å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯æœªæ”¶åˆ°é¢„æœŸçš„æ¶ˆæ¯"></a>å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯æœªæ”¶åˆ°é¢„æœŸçš„æ¶ˆæ¯</h5><pre><code>1.åŸå› ï¼š

1&gt;è¿æ¥æ–­å¼€æ—¶æ¶ˆæ¯æœªå‘é€æˆ–ä¸¢å¤±ã€‚
2&gt;æ¶ˆæ¯é¡ºåºé”™ä¹±æˆ–æœªå¤„ç†ã€‚

2.è§£å†³æ–¹æ³•ï¼š

1&gt;ç¡®è®¤æ¶ˆæ¯å¯é æ€§ï¼šåœ¨æ¶ˆæ¯ä¸­åŠ å…¥åºåˆ—å·æˆ–å”¯ä¸€æ ‡è¯†ï¼ŒæœåŠ¡ç«¯ç¡®è®¤å¤„ç†æˆåŠŸåå†ç»§ç»­ã€‚

    å®¢æˆ·ç«¯ç¤ºä¾‹

    <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> messageCounter = <span class="number">0</span>; <span class="comment">// åºåˆ—å·</span></span><br><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;ws://example.com/socket&#x27;</span>);</span><br><span class="line"></span><br><span class="line">ws.onopen = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> message = &#123; <span class="attr">id</span>: ++messageCounter, <span class="attr">content</span>: <span class="string">&#x27;Hello, Server!&#x27;</span> &#125;;</span><br><span class="line">    ws.send(<span class="built_in">JSON</span>.stringify(message));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ws.onmessage = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="built_in">JSON</span>.parse(event.data);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Received:&#x27;</span>, data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
    æœåŠ¡ç«¯ç¤ºä¾‹ (Node.js)

    <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> WebSocket = <span class="built_in">require</span>(<span class="string">&#x27;ws&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> wss = <span class="keyword">new</span> WebSocket.Server(&#123; <span class="attr">port</span>: <span class="number">8080</span> &#125;);</span><br><span class="line"></span><br><span class="line">wss.on(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">ws</span>) =&gt;</span> &#123;</span><br><span class="line">    ws.on(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="built_in">JSON</span>.parse(message);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;Received message with ID:&#x27;</span>, data.id);</span><br><span class="line">        ws.send(<span class="built_in">JSON</span>.stringify(&#123; <span class="attr">id</span>: data.id, <span class="attr">status</span>: <span class="string">&#x27;received&#x27;</span> &#125;));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

2&gt;è¡¥å¿æœºåˆ¶ï¼šå½“æ£€æµ‹åˆ°æ¶ˆæ¯ä¸¢å¤±æ—¶ï¼Œé‡æ–°å‘é€ä¸¢å¤±çš„æ¶ˆæ¯ã€‚

    å®¢æˆ·ç«¯ç¤ºä¾‹

    <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> messageQueue = [];</span><br><span class="line"><span class="keyword">let</span> messageCounter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;ws://example.com/socket&#x27;</span>);</span><br><span class="line"></span><br><span class="line">ws.onopen = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    sendWithRetry(&#123; <span class="attr">content</span>: <span class="string">&#x27;Hello, Server!&#x27;</span> &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ws.onmessage = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="built_in">JSON</span>.parse(event.data);</span><br><span class="line">    <span class="keyword">if</span> (data.status === <span class="string">&#x27;received&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// ç¡®è®¤æ¶ˆæ¯å·²æ¥æ”¶ï¼Œä»é˜Ÿåˆ—ä¸­ç§»é™¤</span></span><br><span class="line">        messageQueue = messageQueue.filter(<span class="function">(<span class="params">msg</span>) =&gt;</span> msg.id !== data.id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendWithRetry</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> msg = &#123; <span class="attr">id</span>: ++messageCounter, ...message &#125;;</span><br><span class="line">    messageQueue.push(msg);</span><br><span class="line">    ws.send(<span class="built_in">JSON</span>.stringify(msg));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœ 3 ç§’æœªç¡®è®¤ï¼Œé‡æ–°å‘é€</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (messageQueue.find(<span class="function">(<span class="params">msg</span>) =&gt;</span> msg.id === msg.id)) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;Retrying message:&#x27;</span>, msg.id);</span><br><span class="line">            ws.send(<span class="built_in">JSON</span>.stringify(msg));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    æœåŠ¡ç«¯å¤„ç†ï¼šé˜²æ­¢é‡å¤æ¶ˆæ¯

    <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> processedMessages = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line"></span><br><span class="line">wss.on(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">ws</span>) =&gt;</span> &#123;</span><br><span class="line">    ws.on(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="built_in">JSON</span>.parse(message);</span><br><span class="line">        <span class="keyword">if</span> (!processedMessages.has(data.id)) &#123;</span><br><span class="line">            processedMessages.add(data.id);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;Processing message:&#x27;</span>, data);</span><br><span class="line">            ws.send(<span class="built_in">JSON</span>.stringify(&#123; <span class="attr">id</span>: data.id, <span class="attr">status</span>: <span class="string">&#x27;received&#x27;</span> &#125;));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;Duplicate message ignored:&#x27;</span>, data.id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
3&gt;é˜Ÿåˆ—å¤„ç†ï¼šåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç¡®ä¿æ¶ˆæ¯æŒ‰åºåˆ°è¾¾å¹¶å¤„ç†ã€‚

    æœåŠ¡ç«¯ç¤ºä¾‹ (Redis Pub/Sub)

    <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> WebSocket = <span class="built_in">require</span>(<span class="string">&#x27;ws&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> Redis = <span class="built_in">require</span>(<span class="string">&#x27;ioredis&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pub = <span class="keyword">new</span> Redis();</span><br><span class="line"><span class="keyword">const</span> sub = <span class="keyword">new</span> Redis();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wss = <span class="keyword">new</span> WebSocket.Server(&#123; <span class="attr">port</span>: <span class="number">8080</span> &#125;);</span><br><span class="line"></span><br><span class="line">sub.subscribe(<span class="string">&#x27;chat&#x27;</span>);</span><br><span class="line">sub.on(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">channel, message</span>) =&gt;</span> &#123;</span><br><span class="line">    wss.clients.forEach(<span class="function">(<span class="params">client</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (client.readyState === WebSocket.OPEN) &#123;</span><br><span class="line">            client.send(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">wss.on(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">ws</span>) =&gt;</span> &#123;</span><br><span class="line">    ws.on(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">        pub.publish(<span class="string">&#x27;chat&#x27;</span>, message);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    é€‚é…æ–­çº¿é‡è¿ï¼ˆé˜²æ­¢ä¸¢å¤±æœªå‘é€çš„æ¶ˆæ¯ï¼‰

    <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> messageQueue = [];</span><br><span class="line"><span class="keyword">let</span> ws;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    ws = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;ws://example.com/socket&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    ws.onopen = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;Connected&#x27;</span>);</span><br><span class="line">        <span class="comment">// é‡å‘æœªå‘é€çš„æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">while</span> (messageQueue.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> msg = messageQueue.shift();</span><br><span class="line">            ws.send(<span class="built_in">JSON</span>.stringify(msg));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ws.onmessage = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="built_in">JSON</span>.parse(event.data);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;Received:&#x27;</span>, data);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ws.onclose = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;Disconnected. Reconnecting...&#x27;</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(connect, <span class="number">5000</span>); <span class="comment">// 5 ç§’åå°è¯•é‡è¿</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> msg = &#123; <span class="attr">id</span>: ++messageCounter, ...message &#125;;</span><br><span class="line">    <span class="keyword">if</span> (ws.readyState === WebSocket.OPEN) &#123;</span><br><span class="line">        ws.send(<span class="built_in">JSON</span>.stringify(msg));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœè¿æ¥æœªå»ºç«‹ï¼Œå°†æ¶ˆæ¯å­˜å…¥é˜Ÿåˆ—</span></span><br><span class="line">        messageQueue.push(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">connect();</span><br><span class="line"></span><br></pre></td></tr></table></figure></code></pre>
<h5 id="æ•°æ®å¯èƒ½åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«çªƒå¬æˆ–ç¯¡æ”¹"><a href="#æ•°æ®å¯èƒ½åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«çªƒå¬æˆ–ç¯¡æ”¹" class="headerlink" title="æ•°æ®å¯èƒ½åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«çªƒå¬æˆ–ç¯¡æ”¹"></a>æ•°æ®å¯èƒ½åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«çªƒå¬æˆ–ç¯¡æ”¹</h5><pre><code>1.åŸå› ï¼šä½¿ç”¨æœªåŠ å¯†çš„ WebSocket (ws://) è¿›è¡Œé€šä¿¡ã€‚

2.è§£å†³æ–¹æ³•ï¼š

1&gt;ä½¿ç”¨åŠ å¯†è¿æ¥ (WSS)ï¼šé…ç½®æœåŠ¡ç«¯æ”¯æŒ TLSï¼Œå¹¶ä½¿ç”¨ wss://ã€‚
2&gt;éªŒè¯æ¥æºï¼šé€šè¿‡ Origin å¤´éƒ¨æ ¡éªŒ WebSocket è¯·æ±‚æ¥æºã€‚

    <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Node.js ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> WebSocket = <span class="built_in">require</span>(<span class="string">&#x27;ws&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> wss = <span class="keyword">new</span> WebSocket.Server(&#123; <span class="attr">port</span>: <span class="number">8080</span> &#125;);</span><br><span class="line"></span><br><span class="line">wss.on(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">ws, req</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> origin = req.headers.origin;</span><br><span class="line">    <span class="keyword">if</span> (origin !== <span class="string">&#x27;https://example.com&#x27;</span>) &#123;</span><br><span class="line">        ws.close();</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">&#x27;Unauthorized origin:&#x27;</span>, origin);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
3&gt;èº«ä»½éªŒè¯ï¼šåœ¨è¿æ¥æ¡æ‰‹é˜¶æ®µé€šè¿‡ URL å‚æ•°æˆ–å¤´éƒ¨ä¼ é€’ Token éªŒè¯èº«ä»½

    <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;wss://example.com/socket?token=YOUR_TOKEN&#x27;</span>);</span><br></pre></td></tr></table></figure></code></pre>
<h5 id="å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥å¯¼è‡´æœåŠ¡å™¨æ€§èƒ½ä¸‹é™"><a href="#å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥å¯¼è‡´æœåŠ¡å™¨æ€§èƒ½ä¸‹é™" class="headerlink" title="å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥å¯¼è‡´æœåŠ¡å™¨æ€§èƒ½ä¸‹é™"></a>å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥å¯¼è‡´æœåŠ¡å™¨æ€§èƒ½ä¸‹é™</h5><pre><code>1.åŸå› ï¼š

    1&gt;å•æœåŠ¡å™¨å¤„ç†çš„è¿æ¥æ•°æœ‰é™ã€‚
    2&gt;æœªé‡Šæ”¾æ— æ•ˆæˆ–è¿‡æœŸçš„è¿æ¥ã€‚

2.è§£å†³æ–¹æ³•ï¼š

    1&gt;è¿æ¥ç®¡ç†ï¼šå®šæœŸæ¸…ç†é•¿æ—¶é—´æœªæ´»åŠ¨çš„è¿æ¥ã€‚
    2&gt;æ°´å¹³æ‰©å±•ï¼šä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨ï¼ˆå¦‚ Nginxï¼‰åˆ†å‘è¿æ¥ã€‚éƒ¨ç½²å¤šå° WebSocket æœåŠ¡å®ä¾‹ã€‚
    3&gt;æ¶ˆæ¯å¹¿æ’­ä¼˜åŒ–ï¼šå¯¹éœ€è¦å¹¿æ’­çš„æ¶ˆæ¯ï¼Œä½¿ç”¨å‘å¸ƒ/è®¢é˜…æ¨¡å¼æˆ–æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆå¦‚ Redis Pub/Subï¼‰ã€‚</code></pre>
<h5 id="æŸäº›è€ç‰ˆæœ¬æµè§ˆå™¨æˆ–ç‰¹æ®Šç¯å¢ƒä¸‹ä¸æ”¯æŒ-WebSocket"><a href="#æŸäº›è€ç‰ˆæœ¬æµè§ˆå™¨æˆ–ç‰¹æ®Šç¯å¢ƒä¸‹ä¸æ”¯æŒ-WebSocket" class="headerlink" title="æŸäº›è€ç‰ˆæœ¬æµè§ˆå™¨æˆ–ç‰¹æ®Šç¯å¢ƒä¸‹ä¸æ”¯æŒ WebSocket"></a>æŸäº›è€ç‰ˆæœ¬æµè§ˆå™¨æˆ–ç‰¹æ®Šç¯å¢ƒä¸‹ä¸æ”¯æŒ WebSocket</h5><pre><code>1.åŸå› ï¼š

    WebSocket æ˜¯è¾ƒæ–°çš„åè®®ï¼Œæ—§è®¾å¤‡å¯èƒ½ä¸æ”¯æŒã€‚

2.è§£å†³æ–¹æ³•ï¼š

    1&gt;é™çº§ä¸ºè½®è¯¢ï¼š ä½¿ç”¨ Socket.IO ç­‰åº“ï¼Œå¯ä»¥è‡ªåŠ¨é™çº§ä¸º HTTP é•¿è½®è¯¢ã€‚

    <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> io = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>)(server);</span><br><span class="line">io.on(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">socket</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Client connected&#x27;</span>);</span><br><span class="line">    socket.on(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">msg</span>) =&gt;</span> <span class="built_in">console</span>.log(msg));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
    2&gt;æ£€æµ‹æ”¯æŒæƒ…å†µ

        åœ¨å®¢æˆ·ç«¯è¿è¡Œç¯å¢ƒä¸­æ£€æµ‹ WebSocket æ”¯æŒ

        <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">&#x27;WebSocket&#x27;</span> <span class="keyword">in</span> <span class="built_in">window</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;WebSocket supported&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;WebSocket not supported&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></code></pre>
<hr>

            <br />
            <p class="meta">
                
            </p>
        </div>

        <div class="col-sm-3">
             
<span><b> TL;DR</b></span>
<p>
	Yet another hexo theme.
</p>
<hr />


<span><b> TL;DR 2</b></span>
<p>
	No, not another one :/
</p>
<hr />

 

<span
	><a href="https://twitter.com/hexojs" target="_blank" rel="noopener"
		><b
			><i class="fab fa-twitter-square"></i>
			<i class="fas fa-at"></i>
			hexojs</b
		></a
	></span
>
<br />
<a class="twitter-timeline" data-height="800" data-dnt="true" data-chrome="nofooter transparent noheader noborders " target="_blank" rel="noopener" href="https://twitter.com/hexojs?ref_src=twsrc%5Etfw"></a>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


        </div>
    </div>
</div>
<!-- Menu fade on scroll -->
<script>
    var isScrolling;
    var prevScrollpos = window.pageYOffset;
    window.addEventListener(
        'scroll',
        function(event) {
            window.clearTimeout(isScrolling);
            isScrolling = setTimeout(function() {
                var currentScrollPos = window.pageYOffset;
                if (prevScrollpos > currentScrollPos) {
                    $('#navbar').slideDown();
                } else {
                    $('#navbar').slideUp();
                }
                prevScrollpos = currentScrollPos;
            }, 66);
        },
        false
    );
</script>


<a class="float-left gradient btn paginationbtn" href="/2024/11/15/Next.js/"><i class="fas fa-chevron-left"></i></a>


    </main>
    <!-- Footer -->
    <footer class="page-footer">
  <div class="container">
    <div class="social-icons">
      
      <a href="https://hexo.io/" title="Hexo.io" target="_blank" rel="noopener" class="fas fa-home"></a>
      
      <a href="https://twitter.com/hexojs" title="@hexojs" target="_blank" rel="noopener" class="fab fa-twitter"></a>
      
      <a href="https://github.com/RandomAdversary/Gradient/issues" title="Report issue" target="_blank" rel="noopener" class="fas fa-bug"></a>
      
    </div>
  </div>
</footer>
    <!-- After footer scripts -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>
</body>

</html>